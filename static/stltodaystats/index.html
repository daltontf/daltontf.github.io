<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf8" />
  <link rel='stylesheet' type='text/css' href='styles.css'>
  <title>STLtoday High School Sport Stats DB</title>
</head>
<script src='./sql-wasm.js'></script>
<script>
  var SQL;
  var DB;

  // tables to use to lookup school names for the sport
  const SPORT_SCHOOL_TABLES = {
      "baseball": "hitting_1",
      "basketballb": "offense",
      "basketballg": "offense",
      "fieldhockey": "scoring",
      "football": "rushing",
      "hockey": "scoring",
      "lacrosseb": "scoring",
      "lacrosseg": "scoring",
      "soccerb": "scoring",
      "soccerg": "scoring",
      "softball":  "hitting_1",
      "volleyballb": "serving",
      "volleyballg": "serving",
      "waterpolob": "scoring",
      "waterpolog": "scoring"
  }

    // sports shared query sets
  const SPORT_QUERY_SET = {
      "baseball": "baseball_softball",
      "basketballb": "basketball",
      "basketballg": "basketball",
      "fieldhockey": "fieldhockey",
      "football": "football",
      "hockey": "hockey",
      "lacrosseb": "lacrosse",
      "lacrosseg": "lacrosse",
      "soccerb": "soccer",
      "soccerg": "soccer",
      "softball":  "baseball_softball",
      "volleyballb": "volleyball",
      "volleyballg": "volleyball",
      "waterpolob": "waterpolo",
      "waterpolog": "waterpolo"
  }

  var querySets;

  async function init() {
    const sqlPromise = initSqlJs({ locateFile: file => `./${file}` });  
    
    fetch('./queries.js')
        .then((response) => response.text())
        .then((queries) => { 
          querySets = eval(queries);
          updateQueries();
        });
    
    SQL = await sqlPromise; 
    updateDb();
  }  

  function updateQueries() {
    const selectedSport = document.getElementById("selectSport").selectedOptions[0].value;
    const querySelect = document.getElementById("queries");
    querySelect.innerHTML = "";
    querySelect.options.add(new Option("", ""));

    if (querySets && selectedSport) {
      const queries = querySets[SPORT_QUERY_SET[selectedSport]];    

      if (queries) {
        for (var i = 0, max = queries.length; i < max; i++) {
          querySelect.add(new Option(queries[i].description, i));
        }
      }
    }
  }

  async function updateDb() {
    const selectedSport = document.getElementById("selectSport").selectedOptions[0].value;
    const dataPromise = fetch("./" + selectedSport + ".db").then(res => res.arrayBuffer());
    const buf = await dataPromise;
    DB = new SQL.Database(new Uint8Array(buf));

    var select = document.getElementById("schools");
    select.innerHTML = "";
    select.options.add(new Option("ALL", ""));

    const stmt = DB.prepare("select distinct school from " + SPORT_SCHOOL_TABLES[selectedSport] + " order by school asc");

    while(stmt.step()) { //
      const rowData = stmt.getAsObject();
      const school = rowData["school"];
      select.options.add(new Option(school,school))
    }

    updateQueries();

    setQuery(""); 
  }

  function querySelected() {
    const sport = document.getElementById("selectSport").selectedOptions[0].value; 
    const queryIndex = document.getElementById("queries").selectedIndex;
    if (queryIndex > 0) {
      const query = querySets[SPORT_QUERY_SET[sport]][queryIndex - 1];
      setQuery(query.sql);
    } else {
      setQuery(""); 
    }
  }

  function setQuery(value) {
    document.getElementById("query").value = value;
  }

  function clearResults() {
    document.getElementById("results").innerHTML = "";  
  }

  function executeQuery() {    
      var school = document.getElementById("schools").selectedOptions[0].value;
      const executeButton = document.getElementById("execute");
      // Prepare a statement
      try {
        executeButton.disabled = true;

        var querySQL = document.getElementById("query").value;

        if (querySQL.toUpperCase().indexOf(" LIMIT ") == -1) {
          querySQL += " LIMIT 250";
        }

        const stmt = DB.prepare(querySQL);

        stmt.bind({$school:school + "%"});

        var table = document.getElementById("results");
        table.innerHTML = ""; 

        var headerRendered = false;

        var index = 0;

        while(stmt.step()) { //
          const rowData = stmt.getAsObject();
          if (!headerRendered) {
            var row = table.insertRow();
            var cell = row.insertCell();
            cell.innerHTML = "#";
            for (var key in rowData) { 
              cell = row.insertCell();
              cell.innerHTML = key; 
            }
            headerRendered = true;
          }
          var row = table.insertRow();
          var cell = row.insertCell();
          cell.innerHTML = "" + (++index);
          for (var key in rowData) { 
            cell = row.insertCell();
            cell.innerHTML = rowData[key]; 
          }
        }
      } catch (ex) {
        alert("Failure executing query:\n\n" + ex);
      }
      executeButton.disabled = false;
  }

  function showOrHideQuery() {
    let showQuery = document.getElementById("showQuery").checked;
    document.getElementById("query").style.display = showQuery ? "initial" : "none";
  }

</script>
<body onload="init()">
  <h1>STLtoday High School Sport StatsDB<a href="about.html">About</a></h1>

  <p>Sport:
    <select id="selectSport" onchange="updateDb()">
      <option value="baseball">Baseball</option>
      <option value="basketballb">Basketball - Boys</option>
      <option value="basketballg">Basketball - Girls</option>
      <option value="fieldhockey">Field Hockey</option>
      <option value="football">Football</option>
      <option value="hockey">Hockey</option>
      <option value="lacrosseb">Lacrosse - Boys</option>
      <option value="lacrosseg">Lacrosse - Girls</option>
      <option value="soccerb">Soccer - Boys</option>
      <option value="soccerg">Soccer - Girls</option>
      <option value="softball">Softball</option>
      <option value="volleyballb">Volleyball - Boys</option>
      <option value="volleyballg">Volleyball - Girls</option>
      <option value="waterpolob">Water Polo - Boys</option>
      <option value="waterpolog">Water Polo - Girls</option>
    </select>
  </p>
  <p>
    School: <select id="schools"></select>
  </p>
  <p>
    Queries: <select id="queries" onchange="querySelected()"></select>
  </p>
  <p>
    Show Query: <input id="showQuery" type="checkbox" onchange="showOrHideQuery()"/>
  </p>
  <p>
    <textarea id="query" rows="10" cols="80" style="display:none" spellcheck="false"></textarea>
  </p>
  <p>
    <button id="execute" onclick="executeQuery()">Execute</button>
  </p>
  <p>
    <table id="results"></table>
  </p>
</body>
</html>